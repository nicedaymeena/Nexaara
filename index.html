{
  "name": "nexaara-backend",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "body-parser": "^1.20.2",
    "cors": "^2.8.5",
    "express": "^4.18.2",
    "firebase-admin": "^11.11.0",
    "helmet": "^7.0.0",
    "razorpay": "^2.1.6"
  }
}
/**
 * Nexaara Backend (Express)
 * - Create Razorpay order
 * - Verify payment & save order to Firebase Firestore
 *
 * ENV vars required:
 *  - RAZORPAY_KEY_ID
 *  - RAZORPAY_KEY_SECRET
 *  - FIREBASE_SERVICE_ACCOUNT (JSON string or use file and set FIREBASE_CERT_PATH)
 *  - PORT (optional)
 *  - FIREBASE_PROJECT_ID (optional)
 *
 * Deploy on Render / Heroku / Vercel (serverless).
 */

const express = require('express');
const Razorpay = require('razorpay');
const crypto = require('crypto');
const bodyParser = require('body-parser');
const admin = require('firebase-admin');
const cors = require('cors');
const helmet = require('helmet');

const app = express();
app.use(helmet());
app.use(cors());
app.use(bodyParser.json());

// ----------------------------------------------------------------
// FIREBASE INITIALIZATION
// Provide either FIREBASE_SERVICE_ACCOUNT (stringified JSON) env var
// or set FIREBASE_CERT_PATH to a file path on server. For local dev,
// set FIREBASE_SERVICE_ACCOUNT.
if (!process.env.FIREBASE_SERVICE_ACCOUNT && !process.env.FIREBASE_CERT_PATH) {
  console.error('Missing Firebase credentials. Set FIREBASE_SERVICE_ACCOUNT (env JSON) or FIREBASE_CERT_PATH.');
  // continue, but will error when used
} else {
  let serviceAccount = null;
  if (process.env.FIREBASE_SERVICE_ACCOUNT) {
    serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);
  } else {
    serviceAccount = require(process.env.FIREBASE_CERT_PATH);
  }
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    // databaseURL: "https://<PROJECT>.firebaseio.com"
  });
}

// Firestore reference
const db = admin.firestore();

// ----------------------------------------------------------------
// RAZORPAY INIT
const RAZORPAY_KEY_ID = process.env.RAZORPAY_KEY_ID || '';
const RAZORPAY_KEY_SECRET = process.env.RAZORPAY_KEY_SECRET || '';

if (!RAZORPAY_KEY_ID || !RAZORPAY_KEY_SECRET) {
  console.error('Razorpay keys missing - set RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET');
}

const razorpay = new Razorpay({
  key_id: RAZORPAY_KEY_ID,
  key_secret: RAZORPAY_KEY_SECRET
});

// ----------------------------------------------------------------
// API: Health
app.get('/', (req, res) => {
  res.json({ ok: true, msg: 'Nexaara backend running' });
});

// ----------------------------------------------------------------
// API: Create Razorpay Order (amount in INR)
app.post('/api/create-order', async (req, res) => {
  /*
    Expected body:
    {
      amount: 5499,    // rupees - integer or float - we convert to paise
      currency: "INR",
      receipt: "order_rcptid_11", // optional
      notes: { productId: 'p1', name: 'Hoodie' }
    }
  */
  try {
    const { amount, currency, receipt, notes } = req.body;
    if (!amount) return res.status(400).json({ error: 'Missing amount' });

    const amtPaise = Math.round(Number(amount) * 100);

    const options = {
      amount: amtPaise,
      currency: currency || 'INR',
      receipt: receipt || `rcpt_${Date.now()}`,
      payment_capture: 1, // automatic capture
      notes: notes || {}
    };

    const order = await razorpay.orders.create(options);
    return res.json({ order });
  } catch (err) {
    console.error('create-order error', err);
    return res.status(500).json({ error: err.message });
  }
});

// ----------------------------------------------------------------
// API: Verify Payment (called by frontend after onApprove) - 
// also used by Razorpay webhook for stronger reliability.
app.post('/api/verify-payment', async (req, res) => {
  /*
    Body expected:
    {
      razorpay_order_id,
      razorpay_payment_id,
      razorpay_signature,
      metadata: { name, phone, address, productId, productName, quantity, price }
    }
  */
  try {
    const { razorpay_order_id, razorpay_payment_id, razorpay_signature, metadata } = req.body;
    if (!razorpay_order_id || !razorpay_payment_id || !razorpay_signature) {
      return res.status(400).json({ error: 'Missing razorpay fields' });
    }

    // Verify signature
    const hmac = crypto.createHmac('sha256', RAZORPAY_KEY_SECRET);
    hmac.update(razorpay_order_id + '|' + razorpay_payment_id);
    const generated_signature = hmac.digest('hex');

    if (generated_signature !== razorpay_signature) {
      return res.status(400).json({ error: 'Invalid signature' });
    }

    // Save order to Firestore
    const ordersRef = db.collection('orders');
    const orderData = {
      orderId: razorpay_order_id,
      paymentId: razorpay_payment_id,
      signature: razorpay_signature,
      metadata: metadata || {},
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      status: 'paid'
    };
    const doc = await ordersRef.add(orderData);

    return res.json({ ok: true, id: doc.id });
  } catch (err) {
    console.error('verify-payment error', err);
    return res.status(500).json({ error: err.message });
  }
});

// ----------------------------------------------------------------
// Optional webhook endpoint (recommended): configure in Razorpay dashboard
app.post('/webhook', bodyParser.raw({ type: '*/*' }), async (req, res) => {
  const secret = process.env.RAZORPAY_WEBHOOK_SECRET || '';
  const signature = req.headers['x-razorpay-signature'];
  const payload = req.body;

  if (!secret || !signature) {
    return res.status(400).send('missing secret or signature');
  }
  // verify
  const expected = crypto.createHmac('sha256', secret).update(payload).digest('hex');
  if (expected !== signature) {
    return res.status(400).send('invalid signature');
  }

  // parse json
  let event = {};
  try { event = JSON.parse(payload.toString()); } catch (e) { event = {}; }

  // handle events - store to firestore
  try {
    const ordersRef = db.collection('razorpay_webhooks');
    await ordersRef.add({ event, receivedAt: admin.firestore.FieldValue.serverTimestamp() });
    return res.status(200).send('ok');
  } catch (err) {
    console.error(err);
    return res.status(500).send('error');
  }
});

// ----------------------------------------------------------------
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`Nexaara backend listening on ${PORT}`);
});
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NEXAARA • Shop</title>
  <meta name="description" content="NEXAARA — Where Quality Meets You. Shop premium products." />
  <style>
    /* Minimal CSS for layout */
    :root{--brand:#0f2b56;--accent:#d4a94d}
    body{font-family:Inter,Arial; margin:0;background:#fafafa;color:#111}
    header{background:#fff; padding:14px 18px; box-shadow:0 2px 6px rgba(0,0,0,0.06);display:flex;align-items:center;gap:18px;justify-content:space-between}
    .logo{font-weight:800;color:var(--brand); font-size:20px}
    main{max-width:1100px;margin:22px auto;padding:0 16px}
    .banner{border-radius:10px; overflow:hidden; box-shadow:0 8px 28px rgba(0,0,0,0.06)}
    .banner img{width:100%;display:block}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-top:18px}
    .card{background:#fff;padding:12px;border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.04)}
    .card img{width:100%; height:230px; object-fit:cover; border-radius:8px}
    .title{font-weight:700;margin-top:8px}
    .price{color:var(--brand); font-weight:800}
    .btn{cursor:pointer; border:0; border-radius:8px; padding:10px 12px; font-weight:700}
    .btn-primary{background:var(--brand); color:#fff}
    .btn-outline{background:#fff;border:1px solid #eee}
    /* responsive */
    @media (max-width:900px){ .grid{ grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){ .grid{ grid-template-columns:1fr } .card img{height:200px} }
    /* detail modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:2000}
    .modal.show{display:flex}
    .modal-panel{width:95%; max-width:900px; background:#fff; border-radius:12px; overflow:hidden; display:flex; gap:0}
    .left{flex:1; padding:20px}
    .right{width:420px; padding:20px; border-left:1px solid #f3f3f3}
    .imgwrap{width:100%; height:360px; background:#f3f3f3; border-radius:8px; overflow:hidden}
    .imgwrap img{width:100%; height:100%; object-fit:cover}
    .small{color:#666; font-size:13px}
  </style>
</head>
<body>

<header>
  <div class="logo">NEXAARA</div>
  <div>
    <a href="/admin.html" style="text-decoration:none;color:var(--brand);font-weight:700">Admin</a>
  </div>
</header>

<main>
  <section class="banner">
    <!-- replace with your banner url -->
    <img src="https://i.imgur.com/YourBannerImage.jpg" alt="NEXAARA Banner">
  </section>

  <h2 style="margin-top:18px">Featured Products</h2>
  <div class="grid" id="productGrid"></div>

  <!-- Product Modal (Detail + Checkout flow) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <div class="left">
        <div class="imgwrap"><img id="mImg" src="" alt=""></div>
        <h3 id="mTitle"></h3>
        <div id="mDesc" class="small"></div>
      </div>
      <div class="right">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800" id="mPrice">$0.00</div>
          <button id="closeModal" class="btn btn-outline">Close</button>
        </div>

        <div style="margin-top:12px">
          <label class="small">Quantity</label>
          <select id="mQty">
            <option>1</option><option>2</option><option>3</option>
          </select>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="buyBtn" class="btn btn-primary">Buy</button>
          <button id="addCartBtn" class="btn btn-outline">Add to Cart</button>
        </div>

        <div style="margin-top:18px" class="small">Proceed to fill shipping details and pay online securely.</div>
      </div>
    </div>
  </div>

  <!-- Checkout Info Page modal (customer enters name/address/contact) -->
  <div id="checkoutModal" class="modal" aria-hidden="true">
    <div class="modal-panel" style="max-width:780px">
      <div style="padding:20px; width:100%">
        <h3>Shipping & Payment</h3>
        <form id="checkoutForm">
          <input type="hidden" id="cfProductId"/>
          <input type="hidden" id="cfProductName"/>
          <input type="hidden" id="cfPrice"/>

          <label class="small">Full name</label>
          <input id="cfName" required style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee"/>

          <label class="small">Phone (WhatsApp)</label>
          <input id="cfPhone" required style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee"/>

          <label class="small">Full Address (House, Street, City, PIN)</label>
          <textarea id="cfAddress" required style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee"></textarea>

          <label class="small">Payment Method</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="payUpi" type="button" class="btn btn-outline">UPI</button>
            <button id="payCard" type="button" class="btn btn-primary">Card</button>
          </div>

          <div id="paymentArea" style="margin-top:14px"></div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button type="button" id="cfCancel" class="btn btn-outline">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Razorpay SDK: we will create order via backend -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
/* ============ CONFIG (REPLACE) ============ */
/* 1) Firebase config from your Firebase console (safe to expose on client) */
const firebaseConfig = {
  apiKey: "REPLACE_API_KEY",
  authDomain: "REPLACE_AUTH_DOMAIN",
  projectId: "REPLACE_PROJECT_ID",
  storageBucket: "REPLACE_BUCKET",
  messagingSenderId: "REPLACE_MSG_SENDER",
  appId: "REPLACE_APP_ID"
};
/* 2) Backend base URL (where server.js is deployed) */
const BACKEND_BASE = "https://your-backend.example.com"; // replace with deployed backend
/* =========================================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const productGrid = document.getElementById('productGrid');
const modal = document.getElementById('modal');
const checkoutModal = document.getElementById('checkoutModal');

let CURRENT_PRODUCT = null;

// load products from Firestore collection "products"
async function loadProducts(){
  const snap = await db.collection('products').orderBy('createdAt','desc').get();
  productGrid.innerHTML = '';
  snap.forEach(doc=>{
    const p = { id: doc.id, ...doc.data() };
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <img src="${p.image}" alt="${p.name}">
      <div class="title">${p.name}</div>
      <div class="small">${p.description || ''}</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="price">₹ ${Number(p.price).toFixed(2)}</div>
        <div>
          <button class="btn btn-outline" onclick="viewProduct('${p.id}')">View</button>
          <button class="btn btn-primary" onclick="buyProduct('${p.id}')">Buy</button>
        </div>
      </div>
    `;
    productGrid.appendChild(el);
  });
}

async function viewProduct(id){
  const doc = await db.collection('products').doc(id).get();
  if(!doc.exists) return alert('Product not found');
  const p = { id: doc.id, ...doc.data() };
  CURRENT_PRODUCT = p;
  document.getElementById('mImg').src = p.image;
  document.getElementById('mTitle').textContent = p.name;
  document.getElementById('mDesc').textContent = p.description || '';
  document.getElementById('mPrice').textContent = '₹ ' + Number(p.price).toFixed(2);
  modal.classList.add('show');
}

function buyProduct(id){
  viewProduct(id);
  setTimeout(()=>document.getElementById('buyBtn').focus(),200);
}

// modal close
document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove('show'));

// Buy button in modal => open checkout modal and prefill
document.getElementById('buyBtn').addEventListener('click', ()=>{
  if(!CURRENT_PRODUCT) return;
  document.getElementById('cfProductId').value = CURRENT_PRODUCT.id;
  document.getElementById('cfProductName').value = CURRENT_PRODUCT.name;
  document.getElementById('cfPrice').value = CURRENT_PRODUCT.price;
  // prefill checkout UI
  document.getElementById('cfName').value = '';
  document.getElementById('cfPhone').value = '';
  document.getElementById('cfAddress').value = '';
  modal.classList.remove('show');
  checkoutModal.classList.add('show');
});

// cancel checkout
document.getElementById('cfCancel').addEventListener('click', ()=> checkoutModal.classList.remove('show'));

// payment handlers
document.getElementById('payUpi').addEventListener('click', () => startPayment('upi'));
document.getElementById('payCard').addEventListener('click', () => startPayment('card'));

// startPayment => create server order then open Razorpay checkout
async function startPayment(method){
  // gather form data
  const name = document.getElementById('cfName').value.trim();
  const phone = document.getElementById('cfPhone').value.trim();
  const address = document.getElementById('cfAddress').value.trim();
  const prodId = document.getElementById('cfProductId').value;
  const prodName = document.getElementById('cfProductName').value;
  const price = Number(document.getElementById('cfPrice').value);
  const qty = Number(document.getElementById('mQty').value || 1); // fallback qty

  if(!name || !phone || !address){
    alert('Please fill name, phone and full address.');
    return;
  }

  // create order on backend (in INR rupees)
  try {
    const orderResp = await fetch(BACKEND_BASE + '/api/create-order', {
      method:'POST', headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        amount: (price * qty), // rupees
        currency: 'INR',
        receipt: `nexaara_${Date.now()}`,
        notes: { productId: prodId, productName: prodName, qty }
      })
    });
    const orderData = await orderResp.json();
    if(!orderData.order) throw new Error(orderData.error || 'Order creation failed');

    const order = orderData.order;
    // Razorpay checkout options
    const options = {
      key: order.key_id || 'PLACEHOLDER', // key id is set on server or not; frontend uses backend's key set in Razorpay script
      amount: order.amount, // in paise
      currency: order.currency,
      name: 'NEXAARA',
      description: prodName,
      order_id: order.id,
      prefill: { name, email: '', contact: phone },
      notes: { address },
      handler: async function (response){
        // response contains razorpay_payment_id, razorpay_order_id, razorpay_signature
        // call backend verify endpoint
        const verifyResp = await fetch(BACKEND_BASE + '/api/verify-payment', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            metadata: {
              name, phone, address, productId: prodId, productName: prodName, qty, amount: (price * qty)
            }
          })
        });
        const vr = await verifyResp.json();
        if(vr.ok){
          alert('Payment success! Order placed.');
          checkoutModal.classList.remove('show');
        } else {
          alert('Payment verified failed. Contact support.');
        }
      },
      modal: { escape: false }
    };

    const rzp = new Razorpay(options);
    rzp.on('payment.failed', function (resp){
      console.error('Payment failed', resp.error);
      alert('Payment failed: ' + resp.error.description);
    });
    rzp.open();

  } catch(err){
    console.error(err);
    alert('Payment error: ' + (err.message || err));
  }
}

// initial load
loadProducts();
</script>
</body>
</html>
<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NEXAARA Admin</title>
  <style>
    body{font-family:Inter,Arial;margin:20px;background:#f7f7f7}
    .box{background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06);max-width:900px;margin:auto}
    input,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #eee}
    button{padding:10px 12px;border-radius:8px;border:0;background:#0f2b56;color:#fff;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  </style>
</head>
<body>
  <div class="box">
    <h2>NEXAARA Admin — Products</h2>

    <div id="authSection">
      <h4>Login</h4>
      <input id="email" placeholder="admin email">
      <input id="password" placeholder="password" type="password">
      <button id="loginBtn">Login</button>
      <div id="authMsg"></div>
    </div>

    <div id="adminPanel" style="display:none">
      <h4>Add Product</h4>
      <input id="pName" placeholder="Product name">
      <input id="pPrice" placeholder="Price (INR)">
      <input id="pImage" placeholder="Image URL">
      <textarea id="pDesc" placeholder="Description"></textarea>
      <button id="addProductBtn">Add Product</button>

      <h4 style="margin-top:20px">Existing Products</h4>
      <table id="productTable"><thead><tr><th>Name</th><th>Price</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config - same as index.html
    const firebaseConfig = {
      apiKey: "REPLACE_API_KEY",
      authDomain: "REPLACE_AUTH_DOMAIN",
      projectId: "REPLACE_PROJECT_ID",
      storageBucket: "REPLACE_BUCKET",
      messagingSenderId: "REPLACE_MSG_SENDER",
      appId: "REPLACE_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // elements
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const authMsg = document.getElementById('authMsg');

    const adminPanel = document.getElementById('adminPanel');
    const addProductBtn = document.getElementById('addProductBtn');
    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pImage = document.getElementById('pImage');
    const pDesc = document.getElementById('pDesc');
    const productTable = document.querySelector('#productTable tbody');

    loginBtn.addEventListener('click', async () => {
      authMsg.textContent = '';
      try{
        const user = await auth.signInWithEmailAndPassword(emailEl.value, passEl.value);
        // Show admin UI
        authMsg.textContent = 'Logged in';
        document.getElementById('authSection').style.display = 'none';
        adminPanel.style.display = 'block';
        loadProducts();
      }catch(err){
        authMsg.textContent = 'Login failed: ' + err.message;
      }
    });

    addProductBtn.addEventListener('click', async () => {
      const name = pName.value.trim(); const price = Number(pPrice.value); const image = pImage.value.trim(); const desc = pDesc.value.trim();
      if(!name || !price || !image) return alert('Please fill name, price, image URL');
      await db.collection('products').add({
        name, price, image, description: desc || '', createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      pName.value='';pPrice.value='';pImage.value='';pDesc.value='';
      loadProducts();
    });

    async function loadProducts(){
      productTable.innerHTML = '';
      const snap = await db.collection('products').orderBy('createdAt','desc').get();
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.name}</td><td>₹ ${Number(d.price).toFixed(2)}</td>
          <td>
            <button onclick="deleteProduct('${doc.id}')">Delete</button>
          </td>`;
        productTable.appendChild(tr);
      });
    }

    window.deleteProduct = async function(id){
      if(!confirm('Delete product?')) return;
      await db.collection('products').doc(id).delete();
      loadProducts();
    }
  </script>
</body>
</html>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // products: readable for all, writable only to authenticated admin users (we'll assume admin email)
    match /products/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.email == 'YOUR_ADMIN_EMAIL@example.com';
    }

    match /orders/{docId} {
      // allow writes from server (using service account) OR from verified backend
      allow read: if request.auth != null && request.auth.token.email == 'YOUR_ADMIN_EMAIL@example.com';
      allow write: if false; // only server should write orders (we do server write)
    }

    // allow admin to read other collections
    match /{document=**} {
      allow read: if true;
    }
  }
}



